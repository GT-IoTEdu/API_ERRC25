# Configuração Apache para IoT-EDU com SAML CAFe
# Arquivo: /etc/apache2/sites-available/iot_edu.conf

# Configurações globais
ServerTokens off
ServerSignature off

# Logs
LogLevel warn
ErrorLog ${APACHE_LOG_DIR}/iot_edu_error.log
CustomLog ${APACHE_LOG_DIR}/iot_edu_access.log combined

# Configuração para HTTP (redirecionamento para HTTPS)
<VirtualHost *:80>
    ServerName iot-edu.cafeexpresso.rnp.br
    ServerAlias iot-edu.dev.ufrgs.br
    
    # Redirecionamento para HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# Configuração para HTTPS
<VirtualHost *:443>
    ServerName iot-edu.cafeexpresso.rnp.br
    ServerAlias iot-edu.dev.ufrgs.br
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/cafeexpresso.rnp.br.cer
    SSLCertificateKeyFile /etc/ssl/private/cafeexpresso.key
    SSLCertificateChainFile /etc/ssl/certs/cafeexpresso.rnp.br.chain
    
    # SSL Security
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384
    SSLHonorCipherOrder on
    SSLCompression off
    
    # Headers de segurança
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Document Root
    DocumentRoot /opt/iot_edu/backend
    
    # Configuração para arquivos estáticos
    Alias /static/ /opt/iot_edu/backend/static/
    <Directory /opt/iot_edu/backend/static/>
        Require all granted
        Options -Indexes
    </Directory>
    
    # Configuração para media files
    Alias /media/ /opt/iot_edu/backend/media/
    <Directory /opt/iot_edu/backend/media/>
        Require all granted
        Options -Indexes
    </Directory>
    
    # Proxy para FastAPI (endpoints da API)
    ProxyPreserveHost On
    ProxyPass /api/ http://127.0.0.1:8000/api/
    ProxyPassReverse /api/ http://127.0.0.1:8000/api/
    
    # Proxy para autenticação SAML
    ProxyPass /auth/ http://127.0.0.1:8000/auth/
    ProxyPassReverse /auth/ http://127.0.0.1:8000/auth/
    
    # Configuração para Django SAML
    ProxyPass /saml2/ http://127.0.0.1:8000/saml2/
    ProxyPassReverse /saml2/ http://127.0.0.1:8000/saml2/
    
    # Configuração para admin Django
    ProxyPass /admin/ http://127.0.0.1:8000/admin/
    ProxyPassReverse /admin/ http://127.0.0.1:8000/admin/
    
    # Configuração para documentação da API
    ProxyPass /docs http://127.0.0.1:8000/docs
    ProxyPassReverse /docs http://127.0.0.1:8000/docs
    
    ProxyPass /openapi.json http://127.0.0.1:8000/openapi.json
    ProxyPassReverse /openapi.json http://127.0.0.1:8000/openapi.json
    
    # Configuração para health check
    ProxyPass /health http://127.0.0.1:8000/health
    ProxyPassReverse /health http://127.0.0.1:8000/health
    
    # Configuração para página inicial
    ProxyPass / http://127.0.0.1:8000/
    ProxyPassReverse / http://127.0.0.1:8000/
    
    # Headers para proxy
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Host "%{HTTP_HOST}e"
    RequestHeader set X-Forwarded-Server "%{HTTP_HOST}e"
    
    # Timeout para requests longos (SAML)
    ProxyTimeout 300
    ProxyBadHeader Ignore
    
    # Configuração de logs específicos
    ErrorLog ${APACHE_LOG_DIR}/iot_edu_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/iot_edu_ssl_access.log combined
</VirtualHost> 